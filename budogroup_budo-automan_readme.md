# budo-automan

## 定时任务循环检查服务实例健康状态，负载指标高于设定值时，增加弹性机器。

### 1. 流程说明

#### 1.1. budo-automan程序启动后，执行定时任务 org.budo.automan.task.InstanceMonitorStatusCheckTask，配置在 spring-task.xml 中。

#### 1.2. 从数据库 t_module_monitor 中读取需要监控的模块列表。

#### 1.3. 通过接口从阿里云拉取每个module_monitor的当前既有实例列表，写入 t_instance_monitor 表，同时将表中存在的过期数据清理。

#### 1.4. 逐个检查每个模块的状态。

##### 1.4.1. t_module_monitor.on 为开关，可指定打开或关闭这个模块的监控。

##### 1.4.2. 如果当前模块已有实例数不足 t_module_monitor.instance_min 配置的最小实例数，则调用接口添加机器。

##### 1.4.3. 逐个检查当前模块的每一个实例的状态。

###### 1.4.3.1. 如果当前实力的启动时间在 t_module_monitor.scaling_interval 配置的时间内，则跳过，暂不检查这个实例。

###### 1.4.3.2. 通过HTTP请求或Dubbo调用的方式，检查这个实例的健康状态，写入 t_instance_monitor_check_log 表。

#### 1.5. 根据健康状态检查结果判断是否需要进行弹性操作。

##### 1.5.1. 针对非弹性固定机器，根据 t_instance_monitor_check_log 的数据，判断当前实例是否连续2个检查周期都失败或超出阈值。

###### 1.5.1.1. 如果超出，执行2个操作，为这个模块弹性增加一个实例，重启这台固定机器。

##### 1.5.2. 针对弹性机器，判断是否连续3次超出阈值，如果超出，增加一台机器。

###### 1.5.2.1. 如果当前模块已有实例数量达到了配置的最大值，则不增加机器。

###### 1.5.2.2. 如果当前模块刚有过弹性操作，尚未超过冷却时间，不调用弹性增加机器接口。

##### 1.5.3. 针对弹性机器，判断是否连续3次低于阈值，如果是，减少一台机器。

###### 1.5.3.1. 如果当前模块已有实例数量不大于配置的最小值，则不减少机器。

###### 1.5.3.2. 如果当前模块刚有过弹性操作，尚未超过冷却时间，不调用弹性移除机器接口。



 # 良心友情链接

[腾讯QQ群快速检索](http://u.720life.cn/s/8cf73f7c)

[软件免费开发论坛](http://u.720life.cn/s/bbb01dc0)